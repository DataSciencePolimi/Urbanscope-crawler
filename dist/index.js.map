{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["'use strict';\r\n// Load system modules\r\n\r\n// Load modules\r\nimport co from 'co';\r\nimport bunyan from 'bunyan';\r\nimport turf from 'turf';\r\nimport grid from 'node-geojson-grid';\r\n\r\n// Load my modules\r\nimport Post from './model/post';\r\nimport { open as openMongo, close as closeMongo } from './model/';\r\nimport gridConfig from '../config/grid-config.json';\r\nimport nils from '../config/nils.json';\r\n\r\n\r\n// Constant declaration\r\n\r\n\r\n// Module variables declaration\r\nlet log = bunyan.createLogger( {\r\n  name: 'cralwer',\r\n  level: 'trace',\r\n} );\r\n\r\n\r\n// Module functions declaration\r\nfunction* savePosts( posts ) {\r\n  let points = turf.featurecollection( posts.map( (p,index) => {\r\n    return turf.point( p.location.coordinates, { index } );\r\n  } ) );\r\n\r\n  let taggedPoints = turf.tag( points, nils, 'ID_NIL', 'nil' );\r\n\r\n  for( let point of taggedPoints.features ) {\r\n    try {\r\n      let { index, nil } = point.properties;\r\n      let rawPost = posts[ index ];\r\n\r\n      // Set the nil\r\n      rawPost.nil = nil;\r\n\r\n      // Create and save the post\r\n      let post = new Post( rawPost );\r\n      yield post.save();\r\n\r\n    } catch( err ) {\r\n      if( err.code===11000 ) {\r\n        log.error( 'Post already present' );\r\n      } else {\r\n        log.error( err, 'Cannot insert post' );\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Module class declaration\r\n\r\n\r\n// Module initialization (at first load)\r\n\r\n\r\n// Entry point\r\nco( function*() {\r\n\r\n  // Setup mongo\r\n  yield openMongo();\r\n\r\n\r\n  // Create the grid points\r\n  log.debug( 'Generating point grids' );\r\n  let fc = grid.json( gridConfig );\r\n  let grids = fc.features.map( f => f.geometry.coordinates );\r\n  log.trace( 'Generated %d grids', grids.length );\r\n\r\n  // Load social\r\n  let social = process.argv[ 2 ];\r\n  log.trace( 'Loading module \"%s\"', social );\r\n  let { query } = require( './social/'+social );\r\n\r\n  // Cycle over the grids\r\n  for( let idx=0; idx<gridConfig.length; idx++ ) {\r\n    let currentMpp = gridConfig[ idx ].mpp;\r\n    let points = grids[ idx ];\r\n    log.debug( 'Current grid %d with %d points', idx, points.length );\r\n\r\n    for( let coords of points ) {\r\n      let lat = coords[ 1 ];\r\n      let lon = coords[ 0 ];\r\n      let radius = currentMpp/1000;\r\n\r\n      try {\r\n        let posts = yield query( lat, lon, radius );\r\n        log.trace( 'Returned %d posts', posts.length );\r\n\r\n        yield savePosts( posts );\r\n\r\n      } catch( err ) {\r\n        if( err.code==='ECONNREFUSED' ) {\r\n          log.error( 'Cannot connect %s', err.message );\r\n        }\r\n\r\n        log.error( err, 'Query failed: %s', err.message );\r\n\r\n      }\r\n    }\r\n    log.debug( 'Done grid %d', idx );\r\n  }\r\n  log.debug( 'Done all grids' );\r\n  closeMongo();\r\n} )\r\n.catch( err => {\r\n  log.fatal( err, 'NUOOOOOOOOO' );\r\n  closeMongo();\r\n} )\r\n.then( ()=> {\r\n  log.info( 'Bye' );\r\n  process.exit(0);\r\n} );\r\n\r\n//  50 6F 77 65 72 65 64  62 79  56 6F 6C 6F 78"],"sourceRoot":"/source/"}