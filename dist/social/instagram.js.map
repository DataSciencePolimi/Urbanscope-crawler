{"version":3,"sources":["social/instagram.js"],"names":[],"mappings":"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","file":"social/instagram.js","sourcesContent":["'use strict';\r\n// Load system modules\r\n\r\n// Load modules\r\nimport moment from 'moment';\r\nimport bunyan from 'bunyan';\r\nimport ig from 'instagram-node';\r\nimport Promise from 'bluebird';\r\n\r\n// Load my modules\r\nimport apiKeys from '../../config/instagram-keys.json';\r\n\r\n\r\n\r\n// Constant declaration\r\nconst MAX_RESULTS = 100; // 33 in reality\r\nconst MAX_REQUESTS = 5000; // jshint ignore: line\r\nconst WINDOW = 1000*60*60; // 1 h;\r\n// const WINDOW = 1000*30; // 30 sec;\r\n// const COLLECTION_NAME = 'tweets';\r\nconst SOCIAL = 'instagram';\r\n\r\n\r\n// Module variables declaration\r\nlet log = bunyan.createLogger( {\r\n  name: SOCIAL,\r\n  level: 'trace',\r\n} );\r\nlet api = ig.instagram();\r\nlog.trace( { apiKeys }, 'Using api keys' );\r\napi.use( apiKeys );\r\n\r\n\r\n\r\n// Module class declaration\r\n\r\n\r\n// Module functions declaration\r\nfunction wrap( media ) {\r\n  log.trace( 'Converting media %s', media.id ); // jshint ignore: line\r\n  let date = moment.unix( media.created_time ); // jshint ignore: line\r\n\r\n  let location = media.location;\r\n\r\n  let post = {\r\n    source: SOCIAL,\r\n    id: media.id,\r\n    text: media.caption,\r\n    date: date.toDate(),\r\n    location: location? {\r\n      type: 'Point',\r\n      coordinates: [ location.longitude, location.latitude ],\r\n    } : null,\r\n    author: media.user.username,\r\n    authorId: media.user.id,\r\n    tags: media.tags,\r\n    raw: media,\r\n  };\r\n\r\n  return post;\r\n}\r\n\r\n\r\n\r\nfunction wrapAll( medias ) {\r\n  log.trace( 'Wrapping %d media to posts', medias.length );\r\n  let wrapped = medias.map( wrap );\r\n  let filtered = wrapped.filter( t => t.location );\r\n  return filtered;\r\n}\r\n\r\n\r\nfunction* query( lat, lon, distance ) {\r\n  try {\r\n    let options = {\r\n      distance,\r\n      count: MAX_RESULTS,\r\n    };\r\n    let [ medias, rem, limit ] = yield api.media_searchAsync( lat, lon, options ); // jshint ignore: line\r\n    log.debug( 'Retrieved %d medias', medias.length );\r\n    return yield wrapAll( medias );\r\n  } catch( err ) {\r\n    if( err.code===429 ) { // Rate limit reached\r\n      log.debug( 'Limit reached, waiting' );\r\n      yield Promise.delay( WINDOW );\r\n      return yield query( lat, lon, distance );\r\n    }\r\n\r\n    throw err;\r\n  }\r\n}\r\n\r\n\r\n// Module initialization (at first load)\r\napi = Promise.promisifyAll( api );\r\n\r\n\r\n// Entry point\r\n\r\n// Exports\r\nexport { query };\r\n\r\n//  50 6F 77 65 72 65 64  62 79  56 6F 6C 6F 78"],"sourceRoot":"/source/"}