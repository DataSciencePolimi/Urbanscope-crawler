{"version":3,"sources":["social/twitter.js"],"names":[],"mappings":"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","file":"social/twitter.js","sourcesContent":["'use strict';\r\n// Load system modules\r\n\r\n// Load modules\r\nimport moment from 'moment';\r\nimport bunyan from 'bunyan';\r\nimport Twitter from 'twit';\r\nimport Promise from 'bluebird';\r\n\r\n// Load my modules\r\nimport apiKeys from '../../config/twitter-keys.json';\r\n\r\n\r\n// Constant declaration\r\nconst MAX_RESULTS = 100;\r\nconst MAX_REQUESTS = 180; // jshint ignore: line\r\nconst WINDOW = 1000*60*15; // 15 min;\r\n// const WINDOW = 1000*30; // 30 sec;\r\n// const COLLECTION_NAME = 'tweets';\r\nconst SOCIAL = 'twitter';\r\nconst DATE_FORMAT = 'dd MMM DD HH:mm:ss ZZ YYYY';\r\n\r\n\r\n// Module variables declaration\r\nlet log = bunyan.createLogger( {\r\n  name: SOCIAL,\r\n  level: 'trace',\r\n} );\r\nlet api = new Twitter( apiKeys );\r\nlog.trace( { apiKeys }, 'Using api keys' );\r\n\r\n\r\n\r\n// Module class declaration\r\n\r\n\r\n// Module functions declaration\r\nfunction wrap( tweet ) {\r\n  log.trace( 'Converting tweet %s', tweet.id_str ); // jshint ignore: line\r\n  let tags = [];\r\n  if( tweet.entities ) {\r\n    tags = tweet.entities.hashtags.map( h => h.text );\r\n  }\r\n  let date = moment( tweet.created_at, DATE_FORMAT, 'en' ); // jshint ignore: line\r\n\r\n  let post = {\r\n    source: SOCIAL,\r\n    id: tweet.id_str, // jshint ignore: line\r\n    text: tweet.text,\r\n    date: date.toDate(),\r\n    location: tweet.coordinates,\r\n    author: tweet.user.screen_name, // jshint ignore: line\r\n    authorId: tweet.user.id_str, // jshint ignore: line\r\n    tags: tags,\r\n    lang: tweet.lang,\r\n    raw: tweet,\r\n  };\r\n\r\n  return post;\r\n}\r\n\r\n\r\n\r\nfunction wrapAll( tweets ) {\r\n  log.trace( 'Wrapping %d tweets to posts', tweets.length );\r\n  let wrapped = tweets.map( wrap );\r\n  let filtered = wrapped.filter( t => t.location );\r\n  return filtered;\r\n}\r\n\r\n\r\nfunction* query( lat, lon, radius ) {\r\n  let geocode = `${lat},${lon},${radius}km`;\r\n  log.trace( 'Geocode: %s', geocode );\r\n\r\n  try {\r\n    let [ data ] = yield api.getAsync( 'search/tweets', { geocode, count: MAX_RESULTS } );\r\n    let tweets = data.statuses;\r\n    log.debug( 'Retrieved %d tweets', tweets.length );\r\n    return wrapAll( tweets );\r\n  } catch( err ) {\r\n    if( err.code===88 ) { // Rate limit reached\r\n      log.debug( 'Limit reached, waiting' );\r\n      yield Promise.delay( WINDOW );\r\n      return yield query( lat, lon, radius );\r\n    }\r\n\r\n    throw err;\r\n  }\r\n}\r\n\r\n\r\n// Module initialization (at first load)\r\napi = Promise.promisifyAll( api );\r\n\r\n\r\n// Entry point\r\n\r\n// Exports\r\nexport { query };\r\n\r\n//  50 6F 77 65 72 65 64  62 79  56 6F 6C 6F 78"],"sourceRoot":"/source/"}